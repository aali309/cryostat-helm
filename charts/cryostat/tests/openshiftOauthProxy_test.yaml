suite: test openshiftOauthProxy
templates:
  - deployment.yaml

tests:
  - it: should correctly configure the openshift oauth proxy
    set:
      authentication:
        openshift:
          enabled: true
      openshiftOauthProxy:
        image:
          repository: example/openshift-oauth-proxy
          tag: "v3.11"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
      global:
        cookieSecret: cookieSecretValue
    asserts:
      - hasDocuments:
          count: 1
      - contains:
          path: "spec.template.spec.containers[?(@.name == 'cryostat-authproxy')]"
          content: |
            name: cryostat-authproxy
            image: "example/openshift-oauth-proxy:v3.11"
            args:
              - --skip-provider-button=true
              - --pass-access-token=false
              - --pass-user-bearer-token=false
              - --pass-basic-auth=false
              - --upstream=http://localhost:8181/
              - --upstream=http://localhost:3000/grafana/
              - --upstream=http://localhost:8333/storage/
              - --cookie-secret=cookieSecretValue
              - --openshift-service-account=default
              - --proxy-websockets=true
              - --http-address=0.0.0.0:4180
              - --https-address=:8443
              - --tls-cert=/etc/tls/private/tls.crt
              - --tls-key=/etc/tls/private/tls.key
              - --proxy-prefix=/oauth2
              - --bypass-auth-for=^/health(/liveness)?$
            ports:
              - containerPort: 4180
                protocol: TCP
            volumeMounts:
              - name: alpha-config
                mountPath: /etc/oauth2_proxy/alpha_config
